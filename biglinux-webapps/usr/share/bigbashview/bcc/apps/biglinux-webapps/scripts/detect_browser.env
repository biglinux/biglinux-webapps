#!/usr/bin/env bash

#Translation

export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=biglinux-webapps

FLATPAK_BIN=/var/lib/flatpak/exports/bin
SNAPD_BIN=/var/lib/snapd/snap/bin

declare -a browser_bin_list=(
    "brave"
    "brave-nightly"
    "brave-browser-nightly"
    "com.brave.Browser"
    "firefox"
    "org.mozilla.firefox"
    "firefoxpwa"
    "librewolf"
    "io.gitlab.librewolf-community"
    "firedragon"
    "vivaldi-stable"
    "vivaldi-snapshot"
    "chromium"
    "org.chromium.Chromium"
    "google-chrome-stable"
    "google-chrome-beta"
    "google-chrome-unstable"
    "com.google.Chrome"
    "microsoft-edge-beta"
    "microsoft-edge-dev"
    "microsoft-edge-stable"
    "com.microsoft.Edge"
    "iron"
    "yandex-browser-stable"
    "yandex-browser-beta"
    "naver-whale-stable"
    "iridium"
    "decentr-browser-stable"
    "thorium-browser"
    "flashpeak-slimjet"
    "epiphany"
    "org.gnome.Epiphany"
    "electron"
)

for i in {20..5}; do
    browser_bin_list+=("electron$i")
done
# waiting for opera devs to add support for webapps

browser_bin_list+=("bbv-client")

declare -A browser_trans
declare -a available_browsers

for browser in "${browser_bin_list[@]}"; do

    # Adding translations
    case "$browser" in
    bbv-client)
        browser_trans["$browser"]=$"WEBVIEW"
        ;;
    electron*)
        browser_trans["$browser"]=$"ELECTRON"" ${browser#electron}"
        ;;
    *)
        name="${browser##*.}"
        name="${name/-browser/}"
        name="${name%-stable}" # removes versioning
        name="${name%-community}"
        name="${name#microsoft-}" # removes branding
        name="${name#google-}"
        name="${name#flashpeak-}"
        name="${name/-/ }"
        name="${name^^}" # to uppercase

        binary=$(which "$browser" 2>/dev/null)
        if [ -x "${binary##/usr/local/*}" ]; then
            browser_trans["$browser"]=$"$name"
        elif [ -x "${FLATPAK_BIN}/$browser" ]; then
            browser_trans["$browser"]=$"$name"" (FLATPAK)"
        elif [ -x "${SNAPD_BIN}/$browser" ]; then
            browser_trans["$browser"]=$"$name"" (SNAP)"
        else
            browser_trans["$browser"]=$"$name"
        fi
        ;;
    esac

    # Listing available
    shopt -s lastpipe
    which -a "$browser" 2>/dev/null | grep -Ev "/usr/local/|${SNAPD_BIN}" |
        while read -r br; do
            available_browsers+=("$br")
        done
    shopt -u lastpipe

    if [ -x "${FLATPAK_BIN}/$browser" ]; then
        available_browsers+=("${FLATPAK_BIN}/$browser")
    fi

    if [ -x "${SNAPD_BIN}/$browser" ]; then
        available_browsers+=("${SNAPD_BIN}/$browser")
    fi
done

declare -A categories=(
    ["Development"]=$"DESENVOLVIMENTO"
    ["Office"]=$"ESCRITÓRIO"
    ["Graphics"]=$"GRÁFICOS"
    ["Network"]=INTERNET
    ["Game"]=$"JOGOS"
    ["AudioVideo"]=$"MULTIMÍDIA"
    ["Webapps"]=$"WEBAPPS"
    ["Google"]=$"WEBAPPS GOOGLE"
)

export FLATPAK_BIN SNAPD_BIN browser_bin_list browser_trans categories available_browsers

detect_browser() {

    write_browser() {
        case "$1" in
        *firefox | *firedragon | *librewolf*)
            ../change_browser.sh "blink" "${2:-$1}"
            ;;
        *)
            printf "%s" "${2:-$1}" >~/.bigwebapps/BROWSER
            ;;
        esac
    }

    write_browser "$available_browsers"
}

shortappname() {
    case "$1" in
    # this needs to be sorted by popularity, but i'm too lazy :)
    *"cleverpdf") : "cleverpdf.com" ;;
    *"netflix") : "netflix.com" ;;
    *"youtube-music") : "music.youtube.com" ;;
    *"youtube") : "youtube.com" ;;
    *"twitch") : "twitch.tv" ;;
    *"facebook") : "facebook.com" ;;
    *"twitter") : "twitter.com" ;;
    *"instagram") : "instagram.com" ;;
    *"reddit") : "reddit.com" ;;
    *"pinterest") : "pinterest.com" ;;
    *"linkedin") : "linkedin.com" ;;
    *"messenger") : "messenger.com" ;;
    *"whatsapp") : "web.whatsapp.com" ;;
    *"odysee") : "odysee.com" ;;
    *"spotify") : "spotify.com" ;;
    *"msoffice") : "office.com" ;;
    *"outlook") : "outlook.com" ;;
    *"onedrive") : "onedrive.com" ;;
    *"discord") : "discord.com/app" ;;
    *"msteams") : "teams.microsoft.com" ;;
    *"skype") : "web.skype.com" ;;
    *"telegram") : "web.telegram.com" ;;
    *"slack") : "slack.com" ;;
    *"deezer") : "deezer.com" ;;
    *"gmail") : "mail.google.com" ;;
    *"gclassroom") : "classroom.google.com" ;;
    *"gsheets") : "docs.google.com/spreadsheets" ;;
    *"gdocs") : "docs.google.com" ;;
    *"gdrive") : "drive.google.com" ;;
    *"gcalendar") : "calendar.google.com" ;;
    *"gcontacts") : "contacts.google.com" ;;
    *"gphotos") : "photos.google.com" ;;
    *"hangouts") : "hangouts.google.com" ;;
    *"gkeep") : "keep.google.com" ;;
    *"gmaps") : "maps.google.com" ;;
    *"gmeet") : "meet.google.com" ;;
    *"gslides") : "docs.google.com/presentation" ;;
    *"gtrans") : "translate.google.com" ;;
    *"gdraw") : "drawings.google.com" ;;
    *"ymail") : "mail.yahoo.com" ;;
    *) : "$1" ;;
    esac
    url=$_
    printf "%s" "$url"
}

resolve_icon() {
    case "$1" in
    com.brave.Browser) icon='brave' ;;
    electron*) icon='electron' ;;
    *)
        icon="${1##*.}"
        icon="${icon/-browser//}"
        icon="${icon%-stable}" # removes versioning
        icon="${icon%-community}"
        icon="${icon#microsoft-}" # removes branding
        icon="${icon#google-}"
        icon="${icon#flashpeak-}"
        icon="${icon,,}" # to lowercase;;
        ;;
    esac
    printf "%s" "$icon"
}
