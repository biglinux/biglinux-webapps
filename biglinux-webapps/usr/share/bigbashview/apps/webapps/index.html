<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Name of JSON file with translation -->
    <script>const projectName = 'bigcontrolcenter';</script>
    
    <!-- Include the generic header (CSS and JS) -->
    <?include html /usr/share/bigbashview/framework/html/genericHeader.html?>
    
    <!-- Include window control side decorator -->
    <link href="/usr/share/bigbashview/framework/css/client-side-decorator.css" rel="stylesheet">
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="/usr/share/bigbashview/framework/js/client-side-decorator.js" defer></script>
    
    <!-- Includes the window control side shell script -->
    <?include bash /usr/share/bigbashview/framework/shell/windowControlSide.sh 2> /dev/null ?>
    
    <style>
        .browser-button {
            min-width: 10rem;
        }
        .trash-button {
            width: 3rem;
            height: 3rem;
            font-size: 2.5rem;
        }
        .favicons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: nowrap; /* Prevent line breaks */
            overflow-x: auto; /* Allow horizontal scrolling if necessary */
        }
        .medium-favicon {
            width: 38px;
            height: 38px;
            cursor: pointer;
        }
    </style>
</head>
<body x-data="appData()" x-init="fetchData()" @keydown.window="handleGlobalKeypress($event)">
    
    <!-- Using Client Side Decoration: make body transparent to add shadow, and page behaves like a real body -->
    <div id="page">
        <!-- Any component with the 'drag-area' class can be used to drag and move the window -->
        <div id="title-bar" class="drag-area">
        
            <div id="title-auto-change-side" class="row drag-area">
                <img class="circle mini drag-area" src="/usr/share/icons/hicolor/scalable/apps/webapps.svg" alt="WebApps Icon">
                <h5 class="small drag-area" stonejs>WebApps</h5>
            </div>
        
            <div class="field prefix round input-search-center">
                <i>search</i>
                <!-- Using placeholderText to modify in JavaScript for translated text in stonejs -->
                <input type="search" x-model="filterText" @input="filterPrograms()" :placeholder="placeholderText" id="searchInput" x-ref="searchInput" aria-label="Search Programs">
            </div>
            <button @click="showAddModal()" class="tertiary small" stonejs>Add New</button>
        </div>
        
        <div id="main" class="drag-area page-content-without-left-bar">
            <template x-for="(programs, category) in categorizedPrograms" :key="category">
                <div>
                    <h2 x-text="category" class="category-title"></h2>
                    <template x-for="program in programs" :key="program.app_file">
                        <div class="row margin small-padding active-category small-round">
                            <div class="row">
                                <img :src="program.app_icon_url" class="medium" alt="Program Icon" />
                            </div>
                            <div class="max">
                                <span x-text="program.app_name"></span><br>
                                <span class="opacity-40" x-text="program.app_url"></span>
                            </div>
                            <div class="row">
                                <div class="center-align">
                                    <button @click="showBrowserModal(program)" class="surface-bgcolor small-round vertical small-padding" aria-label="Select Browser">
                                        <img :src="'icons/' + program.browser + '.svg'" class="medium" :id="'browser-icon-' + program.app_file" alt="Browser Icon" />
                                    </button>
                                    <button @click="showEditModal(program)" class="surface-bgcolor small-round vertical small-padding" aria-label="Edit Program">
                                        <i class="trash-button">edit</i>
                                    </button>
                                    <button @click="showDeleteModal(program)" class="surface-bgcolor small-round vertical small-padding" aria-label="Delete Program">
                                        <i class="trash-button">delete</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Modal for deleting a program -->
    <dialog class="dialog center middle min-width-60em no-padding no-margin" id="delete-modal">
        <h5 class="small no-round padding center-align drag-area" stonejs>Confirm Deletion</h5>
        <div class="large medium-padding medium-margin medium-line center-align flex">
            <p stonejs>Are you sure you want to delete this program?</p>
            <template x-if="selectedProgram.app_profile !== 'Default'">
                <div>
                    <input type="checkbox" id="delete-folder" x-model="deleteFolder">
                    <label for="delete-folder" stonejs>Also delete configuration folder</label>
                </div>
            </template>
            <nav class="right-align">
                <button @click="deleteProgram()" stonejs>Confirm</button>
                <button @click="hideDeleteModal()" stonejs>Cancel</button>
            </nav>
        </div>
    </dialog>
    
    <!-- Unified Modal for selecting a browser -->
    <dialog class="center middle min-width-full-less-6em no-padding no-margin" id="browser-modal">
        <h5 class="small no-round padding center-align drag-area" small stonejs>Select a Browser</h5>
        <div class="large medium-padding medium-margin medium-line center-align flex">
            <template x-for="browser in browsers" :key="browser.browser">
                <button @click="selectBrowser(browser)" class="surface-bgcolor small-round vertical small-padding margin browser-button" aria-label="Select Browser">
                    <img :src="'icons/' + browser.browser + '.svg'" class="medium" :id="'browser-icon-' + browser.browser" alt="Browser Icon" />
                    <span x-text="getFriendlyBrowserName(browser.browser)"></span>
                </button>
            </template>
            <nav class="right-align">
                <button @click="hideBrowserModal()" stonejs>Close</button>
            </nav>
        </div>
    </dialog>
    
    <!-- Unified modal for editing and adding program details -->
    <dialog class="dialog center middle min-width-60em no-padding no-margin" id="edit-modal" @click.away="handleClickAway">
        <h5 class="small no-round small-padding center-align drag-area" small stonejs x-text="isEditing ? 'Edit Program Details' : 'Add New Item'"></h5>
        <div class="overlay-dialog overlay center-align middle-align" id="overlay">
            <progress class="circle"></progress>
        </div>
        <div class="margin medium-line center-align flex">
            <table class="background-bgcolor">
                <tbody>
                    <tr>
                        <td class="min" stonejs>URL:</td>
                        <td>
                            <div class="field round fill small" style="display: flex; align-items: center;">
                                <input type="text" id="app_url" x-model="selectedProgram.app_url" aria-label="Application URL">
                                <button @click="fetchSiteInfo()" class="no-margin" stonejs>Detect name and icon</button>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="min" stonejs>Name:</td>
                        <td>
                            <div class="field round fill small">
                                <input type="text" id="app_name" x-model="selectedProgram.app_name" aria-label="Application Name">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="min" stonejs>Icon:</td>
                        <td>
                            <button @click="selectIcon()" class="surface-bgcolor small-round vertical small-padding" aria-label="Select Icon">
                                <img :src="selectedProgram.app_icon_url" class="medium" alt="Application Icon" />
                            </button>
                            <template x-if="favicons.length > 0">
                                <div class="favicons">
                                    <template x-for="favicon in favicons" :key="favicon">
                                        <img :src="favicon" @click="selectFavicon(favicon)" class="medium-favicon margin" alt="Favicon" />
                                    </template>
                                </div>
                            </template>
                        </td>
                    </tr>
                    <tr>
                        <td class="min" stonejs>Category:</td>
                        <td>
                            <div class="field suffix round fill small">
                                <select id="app_categories" x-model="selectedProgram.mainCategory" aria-label="Select Category">
                                    <option value="Development" stonejs>Development</option>
                                    <option value="Office" stonejs>Office</option>
                                    <option value="Graphics" stonejs>Graphics</option>
                                    <option value="Network" stonejs>Network</option>
                                    <option value="Game" stonejs>Game</option>
                                    <option value="AudioVideo" stonejs>AudioVideo</option>
                                    <option value="Webapps" stonejs>Webapp</option>
                                    <option value="Utility" stonejs>Utility</option>
                                    <option value="System" stonejs>System</option>
                                </select>
                                <i>arrow_drop_down</i>
                            </div>
                        </td>
                    </tr>
                    <!-- Conditional Profile Option -->
                    <tr x-show="!isFirefoxOrLibreWolf(selectedProgram.browser)">
                        <td class="min" stonejs>Profile:</td>
                        <td>
                            <div class="field round fill small">
                                <label>
                                    <input type="checkbox" x-model="useSeparateProfile">
                                    <span stonejs>Use separate profile</span>
                                </label>
                                <input type="text" id="app_profile" x-model="selectedProgram.app_profile" :disabled="!useSeparateProfile" placeholder="Default" aria-label="Application Profile">
                            </div>
                        </td>
                    </tr>
                    <!-- End of Conditional Profile Option -->
                    <tr>
                        <td class="min" stonejs>Browser:</td>
                        <td>
                            <button @click="showBrowserModal()" class="surface-bgcolor small-round vertical small-padding small-margin browser-button" aria-label="Select Browser">
                                <img :src="selectedProgram.browser_icon_url || 'icons/default-browser-icon.svg'" class="medium" alt="Selected Browser Icon" />
                                <span x-text="getFriendlyBrowserName(selectedProgram.browser)"></span>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <nav class="right-align">
                <button @click="saveProgramDetails()" stonejs>Save</button>
                <button @click="hideEditModal()" stonejs>Cancel</button>
            </nav>
        </div>
    </dialog>
    
    <!-- Alert after changing browser -->
    <div class="tertiary small-round snackbar align-center" id="snackbar">
        <span class="center" stonejs>Changed browser</span>
    </div>
    
    <script>
    function appData() {
        return {
            programs: [],
            filteredPrograms: [],
            filterText: "",
            placeholderText: "Search...",
            categorizedPrograms: {},
            browsers: [],
            selectedProgram: null,
            isEditing: false,
            deleteFolder: false,
            favicons: [],
            useSeparateProfile: false, // Controls the separate profile option
            browserNameMap: {
                "brave": "Brave",
                "firefox": "Firefox",
                "chromium": "Chromium",
                "google-chrome-stable": "Chrome",
                "vivaldi-stable": "Vivaldi",
                "flatpak-brave": "Brave (Flatpak)",
                "flatpak-chrome": "Chrome (Flatpak)",
                "flatpak-chromium": "Chromium (Flatpak)",
                "flatpak-edge": "Edge (Flatpak)",
                "microsoft-edge-stable": "Edge",
                "librewolf": "Librewolf",
                "flatpak-ungoogled-chromium": "Chromium (Flatpak)",
                "flatpak-firefox": "Firefox (Flatpak)",
                "flatpak-librewolf": "Librewolf (Flatpak)",
                "brave-beta": "Brave Beta",
                "brave-nightly": "Brave Nightly",
                "google-chrome-beta": "Chrome Beta",
                "google-chrome-unstable": "Chrome Unstable",
                "vivaldi-beta": "Vivaldi Beta",
                "vivaldi-snapshot": "Vivaldi Snapshot"
            },
    
            /**
             * Fetches initial data for programs and browsers
             */
            fetchData() {
                fetch("get_json.sh")
                    .then(response => response.json())
                    .then(data => {
                        this.programs = data;
                        this.filterPrograms();
                    })
                    .catch(error => {
                        console.error('Error fetching programs data:', error);
                    });
    
                // Fetch the list of installed browsers
                fetch("check_browser.sh?--list-json")
                    .then(response => response.json())
                    .then(data => {
                        this.browsers = data;
                    })
                    .catch(error => {
                        console.error('Error fetching browsers data:', error);
                    });
    
                // Fetch the default browser
                fetch("check_browser.sh?--default")
                    .then(response => response.text())
                    .then(data => {
                        this.defaultBrowser = data.trim();
                    })
                    .catch(error => {
                        console.error('Error fetching default browser:', error);
                    });
            },
    
            /**
             * Handles global keypress events for search functionality
             */
            handleGlobalKeypress(event) {
                if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                    if (event.key === 'Backspace' && this.filterText.length > 0) {
                        this.filterText = this.filterText.slice(0, -1);
                        this.filterPrograms();
                    } else if (event.key.length === 1) {
                        this.filterText += event.key;
                        this.filterPrograms();
                    }
                    this.$nextTick(() => {
                        this.$refs.searchInput.focus();
                    });
                }
            },
    
            /**
             * Filters programs based on the search text
             */
            filterPrograms() {
                if (this.filterText === "") {
                    this.filteredPrograms = this.programs;
                } else {
                    const normalizedFilter = this.normalizeText(this.filterText);
                    this.filteredPrograms = this.programs.filter(program => {
                        const name = this.normalizeText(program.app_name);
                        const url = this.normalizeText(program.app_url);
                        const file = this.normalizeText(program.app_file);
                        return name.includes(normalizedFilter) ||
                            url.includes(normalizedFilter) ||
                            file.includes(normalizedFilter);
                    });
                }
    
                this.filteredPrograms.sort((a, b) => a.app_name.localeCompare(b.app_name));
                this.categorizePrograms();
            },
    
            /**
             * Categorizes programs based on their main category
             */
            categorizePrograms() {
                this.categorizedPrograms = this.filteredPrograms.reduce((acc, program) => {
                    const category = program.app_categories; // Single category per webapp
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(program);
                    return acc;
                }, {});
            },
    
            /**
             * Normalizes text by removing diacritics and converting to lowercase
             * @param {string} text - The text to normalize
             * @returns {string} - Normalized text
             */
            normalizeText(text) {
                if (typeof text !== 'string') return "";
                return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            },
    
            /**
             * Shows the browser selection modal
             */
            showBrowserModal() {
                this.isEditing = true; // Ensure that profile handling is based on current program
                ui('#browser-modal');
            },
    
            /**
             * Hides the browser selection modal
             */
            hideBrowserModal() {
                ui('#browser-modal');
            },
    
            /**
             * Shows the edit modal for a given program
             * @param {Object} program - The program to edit
             */
            showEditModal(program) {
                this.isEditing = true;
                this.selectedProgram = { ...program }; // Clone the program to prevent direct mutations
                // Set mainCategory from app_categories
                this.selectedProgram.mainCategory = program.app_categories;
                if (!this.selectedProgram.browser_icon_url) {
                    this.selectedProgram.browser_icon_url = 'icons/' + program.browser + '.svg';
                }
                // Configure the separate profile option state
                this.useSeparateProfile = this.selectedProgram.app_profile !== 'Default';
                ui('#edit-modal');
            },
    
            /**
             * Shows the add new program modal
             */
            showAddModal() {
                this.isEditing = false;
                this.selectedProgram = {
                    app_name: "",
                    app_url: "",
                    app_icon_url: "/usr/share/icons/hicolor/scalable/apps/applications-network.svg",
                    app_categories: "Webapps",
                    mainCategory: "Webapps",
                    app_profile: "Default",
                    browser: this.defaultBrowser,
                    browser_icon_url: `icons/${this.defaultBrowser}.svg`
                };
                this.useSeparateProfile = false; // Default profile
                ui('#edit-modal');
            },
    
            /**
             * Hides the edit modal and resets favicons
             */
            hideEditModal() {
                ui('#edit-modal');
                this.favicons = [];
            },
    
            /**
             * Saves the program details after editing or adding
             */
            saveProgramDetails() {
                const {
                    browser,
                    app_name,
                    app_url,
                    app_icon_url,
                    mainCategory,
                    app_file,
                    app_profile
                } = this.selectedProgram;
    
                // Define the profile based on the separate profile option
                if (this.useSeparateProfile) {
                    // Check if the profile is defined
                    if (!app_profile || app_profile.trim() === "") {
                        alert("Please specify a profile name or uncheck 'Use separate profile'.");
                        return;
                    }
                } else {
                    this.selectedProgram.app_profile = 'Default';
                }
    
                // Generate a new app_file if it is a new program
                if (!this.isEditing) {
                    this.selectedProgram.app_file = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    this.programs.push(this.selectedProgram);
                }
    
                // Verify if all required fields are defined and not empty
                if (
                    browser !== undefined && browser.trim() !== '' &&
                    app_name !== undefined && app_name.trim() !== '' &&
                    app_url !== undefined && app_url.trim() !== '' &&
                    app_icon_url !== undefined && app_icon_url.trim() !== '' &&
                    mainCategory !== undefined && mainCategory.trim() !== '' &&
                    this.selectedProgram.app_profile !== undefined && this.selectedProgram.app_profile.trim() !== ''
                ) {
                    // Assign the selected category
                    this.selectedProgram.app_categories = mainCategory;
    
                    // Encode the program details for the command
                    const encodedMessage = `${encodeURIComponent(browser)} '${encodeURIComponent(app_name)}' '${encodeURIComponent(app_url)}' '${encodeURIComponent(app_icon_url)}' '${encodeURIComponent(this.selectedProgram.app_categories)}' '${encodeURIComponent(this.selectedProgram.app_profile)}'`;
                    
                    // Remove the existing program if editing
                    if (this.isEditing) {
                        _run(`big-webapps remove '${encodeURIComponent(app_file)}'`);
                    }
                    
                    // Create the program
                    _run(`big-webapps create ${encodedMessage}`);
                } else {
                    alert("All fields are required.");
                    return;
                }
    
                this.hideEditModal();
    
                // Update the JSON after a short delay
                setTimeout(() => {
                    fetch("get_json.sh")
                        .then(response => response.json())
                        .then(data => {
                            this.programs = data;
                            this.filterPrograms();
                        })
                        .catch(error => {
                            console.error('Error updating programs data:', error);
                        });
                }, 100);
            },
    
            /**
             * Selects a browser for the selected program
             * @param {Object} browser - The selected browser
             */
            selectBrowser(browser) {
                this.selectedProgram.browser = browser.browser;
                this.selectedProgram.browser_icon_url = 'icons/' + browser.browser + '.svg';
                // Update the separate profile option based on the new browser
                this.useSeparateProfile = this.selectedProgram.app_profile !== 'Default';
                if (this.isFirefoxOrLibreWolf(browser.browser)) {
                    this.selectedProgram.app_profile = 'Default';
                }
                this.hideBrowserModal();
            },
    
            /**
             * Selects an icon for the selected program
             */
            selectIcon() {
                ui('#overlay');
                fetch("select_icon.sh")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        // Verify if the returned file is not empty before assigning to the variable
                        if (data.trim() !== '') {
                            this.selectedProgram.app_icon_url = data.trim();
                        }
                        ui('#overlay');
                    })
                    .catch(error => {
                        console.error('Error fetching icon:', error);
                        ui('#overlay');
                    });
            },
    
            /**
             * Gets the friendly name for a browser
             * @param {string} browser - The browser identifier
             * @returns {string} - The friendly browser name
             */
            getFriendlyBrowserName(browser) {
                return this.browserNameMap[browser] || browser;
            },
    
            /**
             * Deletes the selected program
             */
            deleteProgram() {
                if (this.deleteFolder) {
                    _run(`big-webapps remove-with-folder '${encodeURIComponent(this.selectedProgram.app_file)}'`);
                } else {
                    _run(`big-webapps remove '${encodeURIComponent(this.selectedProgram.app_file)}'`);
                }
                this.hideDeleteModal();
                // Update the JSON
                fetch("get_json.sh")
                    .then(response => response.json())
                    .then(data => {
                        this.programs = data;
                        this.filterPrograms();
                    })
                    .catch(error => {
                        console.error('Error updating programs data:', error);
                    });
            },
    
            /**
             * Shows the delete confirmation modal for a given program
             * @param {Object} program - The program to delete
             */
            showDeleteModal(program) {
                this.selectedProgram = program;
                this.deleteFolder = false;
                ui('#delete-modal');
            },
    
            /**
             * Hides the delete confirmation modal
             */
            hideDeleteModal() {
                ui('#delete-modal');
            },
    
            /**
             * Updates the browser for a program
             * @param {Object} program - The program to update
             */
            updateProgramBrowser(program) {
                const encodedMessage = `${encodeURIComponent(program.browser)} '${encodeURIComponent(program.app_name)}' '${encodeURIComponent(program.app_url)}' '${encodeURIComponent(program.app_icon_url)}' '${encodeURIComponent(program.app_categories)}' '${encodeURIComponent(program.app_profile)}'`;
                _run(`big-webapps remove '${encodeURIComponent(program.app_file)}'`);
                _run(`big-webapps create ${encodedMessage}`);
                fetch("get_json.sh")
                    .then(response => response.json())
                    .then(data => {
                        this.programs = data;
                        this.filterPrograms();
                    })
                    .catch(error => {
                        console.error('Error updating programs data:', error);
                    });
            },
    
            /**
             * Fetches site information such as title and favicons based on the URL
             */
            fetchSiteInfo() {
                const url = this.selectedProgram.app_url;
                this.fetchTitle(url);
                this.fetchFavicons(url);
            },
    
            /**
             * Fetches the title of a website
             * @param {string} url - The URL of the website
             */
            fetchTitle(url) {
                fetch(`get_title.sh.py?${encodeURIComponent(url)}`)
                    .then(response => response.text())
                    .then(data => {
                        this.selectedProgram.app_name = data;
                    })
                    .catch(error => {
                        console.error('Error fetching title:', error);
                    });
            },
    
            /**
             * Fetches favicons from a website
             * @param {string} url - The URL of the website
             */
            fetchFavicons(url) {
                fetch(`get_favicon.sh.py?${encodeURIComponent(url)}`)
                    .then(response => response.json())
                    .then(data => {
                        this.favicons = data;
                    })
                    .catch(error => {
                        console.error('Error fetching favicons:', error);
                    });
            },
    
            /**
             * Selects a favicon for the selected program
             * @param {string} favicon - The favicon URL to select
             */
            selectFavicon(favicon) {
                this.selectedProgram.app_icon_url = favicon;
            },
    
            /**
             * Determines if the browser is Firefox or Librewolf
             * @param {string} browser - The browser identifier
             * @returns {boolean} - True if Firefox or Librewolf, else false
             */
            isFirefoxOrLibreWolf(browser) {
                const lowerBrowser = browser.toLowerCase();
                return lowerBrowser.includes('firefox') || lowerBrowser.includes('librewolf');
            }
        };
    }
    </script>
</body>
</html>
